(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{390:function(t,e,s){"use strict";s.r(e);var n=s(48),a=Object(n.a)({},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"downgrading-from-v5-0-to-v4-5-or-lower"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#downgrading-from-v5-0-to-v4-5-or-lower","aria-hidden":"true"}},[t._v("#")]),t._v(" Downgrading from v5.0 to v4.5 or lower")]),t._v(" "),s("p",[t._v("If you want to downgrade from v5.0 to v4.5 or lower, you need to migrate down the MongoDB schema before switching to v4.5 and booting.\nPlease follow the steps below.")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("Downgrading is availble for systems running on-premise or running with "),s("a",{attrs:{href:"https://github.com/weseek/growi-docker-compose",target:"_blank",rel:"noopener noreferrer"}},[t._v("weseek/growi-docker-compose"),s("OutboundLink")],1),t._v(".\nPlease note that downgrading is not supported for other forms of system operations.")])]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),s("p",[t._v("Downgrading does not have the potential for data corruption, but there is a risk of data inconsistencies in the page's path.\nPlease undertake it at your own risk as an administrator.")])]),t._v(" "),s("h2",{attrs:{id:"procedure"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#procedure","aria-hidden":"true"}},[t._v("#")]),t._v(" Procedure")]),t._v(" "),s("h3",{attrs:{id:"work-patterns-with-a-local-repository-that-is-meant-for-production"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#work-patterns-with-a-local-repository-that-is-meant-for-production","aria-hidden":"true"}},[t._v("#")]),t._v(" Work Patterns with a Local Repository that is Meant for Production")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("Stop the production server")]),t._v(" "),s("ul",[s("li",[t._v("Keep MongoDB running")])])]),t._v(" "),s("li",[s("p",[t._v("Perform following steps while keeping the v5.0.0 system available")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("Start the bash process if you are using growi-docker-compose")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("docker-compose run -it --rm app "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bash")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("Run "),s("code",[t._v("migrate-mongo down")]),t._v(" command in the "),s("code",[t._v("packages/app")]),t._v(" directory")]),t._v(" "),s("ul",[s("li",[t._v("Run multiple times until "),s("code",[t._v("MIGRATED DOWN: 20211227060705-revision-path-to-page-id-schema-migration.js")]),t._v(" appears in the terminal output.")]),t._v(" "),s("li",[t._v("Note: downgrading from v5.0.0 to v4.5.15 requires  "),s("code",[t._v("migrate-mongo down")]),t._v(" to be run 3 times.")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1st time (20220311011114-convert-page-delete-config)")]),t._v("\nNODE_ENV"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("production node -r dotenv-flow/config node_modules/.bin/migrate-mongo down\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2nd time (20220131001218-convert-redirect-to-pages-to-page-redirect-documents)")]),t._v("\nNODE_ENV"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("production node -r dotenv-flow/config node_modules/.bin/migrate-mongo down\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3rd time (20211227060705-revision-path-to-page-id-schema-migration)")]),t._v("\nNODE_ENV"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("production node -r dotenv-flow/config node_modules/.bin/migrate-mongo down\n")])])])])])]),t._v(" "),s("li",[s("p",[t._v("Switch the v4.5 system to the available state, build the client, then start the server")])])]),t._v(" "),s("h3",{attrs:{id:"patterns-for-cloning-working-repository"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#patterns-for-cloning-working-repository","aria-hidden":"true"}},[t._v("#")]),t._v(" Patterns for Cloning Working Repository")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("Stop the production server")]),t._v(" "),s("ul",[s("li",[t._v("Keep MongoDB running")])])]),t._v(" "),s("li",[s("p",[t._v("Clone the repository in an environment where you can access MongoDB in production")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/weseek/growi -b v5.0.0 --depth 1\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Get dependent libraries")]),t._v("\nyarn lerna bootstrap\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cd")]),t._v(" packages/app\n")])])])]),t._v(" "),s("li",[s("p",[t._v("Create "),s("code",[t._v(".env.local")])]),t._v(" "),s("div",{staticClass:"language-properties extra-class"},[s("pre",{pre:!0,attrs:{class:"language-properties"}},[s("code",[s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("MIGRATIONS_DIR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("src/migrations/")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Please change according to your environment")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("MONGO_URI")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v('"mongodb://${mongodbhost}:27017/growi"')]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("Execute "),s("code",[t._v("migrate-mongo down")]),t._v(" command")]),t._v(" "),s("ul",[s("li",[t._v("Run multiple times until "),s("code",[t._v("MIGRATED DOWN: 20211227060705-revision-path-to-page-id-schema-migration.js")]),t._v(" appears in the terminal output.")]),t._v(" "),s("li",[t._v("Note: downgrading from v5.0.0 to v4.5.15 requires  "),s("code",[t._v("migrate-mongo down")]),t._v(" to be run 3 times.")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1st time (20220311011114-convert-page-delete-config)")]),t._v("\nyarn ts-node node_modules/.bin/migrate-mongo down\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2nd time (20220131001218-convert-redirect-to-pages-to-page-redirect-documents)")]),t._v("\nyarn ts-node node_modules/.bin/migrate-mongo down\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 3rd time (20211227060705-revision-path-to-page-id-schema-migration)")]),t._v("\nyarn ts-node node_modules/.bin/migrate-mongo down\n")])])])]),t._v(" "),s("li",[s("p",[t._v("Delete working repository")])]),t._v(" "),s("li",[s("p",[t._v("Checkout v4.5 tags in production environment")])]),t._v(" "),s("li",[s("p",[t._v("Build client, then start the server")])])]),t._v(" "),s("h2",{attrs:{id:"output-example"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#output-example","aria-hidden":"true"}},[t._v("#")]),t._v(" Output Example")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("node ➜ /workspace/growi/packages/app "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("master"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" $ yarn ts-node node_modules/.bin/migrate-mongo down\n\nyarn run v1.22.17\n$ ts-node -r tsconfig-paths/register -r dotenv-flow/config --transpile-only node_modules/.bin/migrate-mongo down\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"growi:migrate:convert-page-delete-config"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hostname"')]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxxxxxxxxxx"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pid"')]),t._v(":1111,"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"level"')]),t._v(":30,"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"msg"')]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Migration down has successfully applied"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-03-31T05:54:22.448Z"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v"')]),t._v(":0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nMIGRATED DOWN: 20220311011114-convert-page-delete-config.js\nDone "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" 1.71s.\n\nnode ➜ /workspace/growi/packages/app "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("master"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" $ yarn ts-node node_modules/.bin/migrate-mongo down\n\nyarn run v1.22.17\n$ ts-node -r tsconfig-paths/register -r dotenv-flow/config --transpile-only node_modules/.bin/migrate-mongo down\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"growi:migrate:convert-redirect-to-pages-to-page-redirect-documents"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hostname"')]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxxxxxxxxxx"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pid"')]),t._v(":1111,"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"level"')]),t._v(":30,"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"msg"')]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Migration down has successfully applied"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-03-31T05:54:27.944Z"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v"')]),t._v(":0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nMIGRATED DOWN: 20220131001218-convert-redirect-to-pages-to-page-redirect-documents.js\nDone "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" 1.42s.\n\nnode ➜ /workspace/growi/packages/app "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("master"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" $ yarn ts-node node_modules/.bin/migrate-mongo down\n\nyarn run v1.22.17\n$ ts-node -r tsconfig-paths/register -r dotenv-flow/config --transpile-only node_modules/.bin/migrate-mongo down\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"growi:migrate:revision-path-to-page-id-schema-migration"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hostname"')]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxxxxxxxxxx"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pid"')]),t._v(":1111,"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"level"')]),t._v(":30,"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"msg"')]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Migration down has successfully applied"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-03-31T05:54:31.169Z"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v"')]),t._v(":0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nMIGRATED DOWN: 20211227060705-revision-path-to-page-id-schema-migration.js\nDone "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" 1.99s.\n")])])]),s("h2",{attrs:{id:"troubleshoot"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#troubleshoot","aria-hidden":"true"}},[t._v("#")]),t._v(" Troubleshoot")]),t._v(" "),s("h3",{attrs:{id:"error-an-env-var-migrations-dir-must-be-set-error-an-env-var-migrations-dir-must-be-set"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#error-an-env-var-migrations-dir-must-be-set-error-an-env-var-migrations-dir-must-be-set","aria-hidden":"true"}},[t._v("#")]),t._v(" "),s("code",[t._v("ERROR: An env var MIGRATIONS_DIR must be set. Error: An env var MIGRATIONS_DIR must be set.")])]),t._v(" "),s("p",[t._v("Create "),s("code",[t._v(".env.local")]),t._v(" to temporarily set environment variables and set"),s("code",[t._v("MIGRATIONS_DIR")]),t._v(".")]),t._v(" "),s("p",[t._v("The pattern for working with a production local repository specifies "),s("code",[t._v("MIGRATIONS_DIR=dist/migrations/")]),t._v(" that can be run with Node.js.")]),t._v(" "),s("p",[t._v("The pattern for cloning the working repository specifies "),s("code",[t._v("MIGRATIONS_DIR=src/migrations/")]),t._v(" which can be executed with ts-node.")])])},[],!1,null,null,null);e.default=a.exports}}]);